{% extends "layout.html" %}
{% load crispy_forms_tags %}

{% block title %}Sipariş Onay{% endblock %}

{% block body %}
<h2 class="mb-4">Sipariş Onay</h2>

<!-- Firma Bilgisi -->
<div class="card mb-4">
  <div class="card-header">Firma Bilgisi</div>
  <div class="card-body">
    <p><strong>{{ order.customer_company.name }}</strong></p>
    <p>{{ order.customer_company.address }}</p>
    <p>📞 {{ order.customer_company.phone }}</p>
    <p>📧 {{ order.customer_company.email }}</p>
  </div>
</div>

<!-- Sipariş Kalemleri -->
<div class="card mb-4">
  <div class="card-header">Sipariş Ürünleri</div>
  <div class="card-body">
    <ul class="list-group">
      {% for item in order.items.all %}
        <li class="list-group-item d-flex justify-content-between align-items-center" id="cart-item-{{ item.id }}">
          <div>{{ item.product.name_tr }}</div>
          <div class="d-flex align-items-center">
            <input type="number" class="form-control quantity-input me-2" style="width: 80px;"
                   data-id="{{ item.id }}" value="{{ item.quantity }}" min="1">
            <button class="btn btn-danger btn-sm remove-item-btn" data-id="{{ item.id }}">Sil</button>
          </div>
        </li>
      {% endfor %}
    </ul>
  </div>
</div>

<!-- Onay / İptal Butonları -->
<div class="row mt-4">
  <div class="col-md-4">
    <form method="post" action="{% url 'orders:clear_order' order.id %}">
      {% csrf_token %}
      <button type="submit" class="btn btn-outline-danger w-100">❌ Siparişi Sil</button>
    </form>
  </div>
  <div class="col-md-4">
    <a href="{% url 'orders:order_preview_pdf' order.id %}" target="_blank" class="btn btn-outline-primary w-100">
      📄 PDF Önizleme
    </a>
  </div>
  <div class="col-md-4">
    <form method="post" action="{% url 'orders:order_confirm' order.id %}">
      {% csrf_token %}
      <button type="submit" class="btn btn-outline-success w-100">✅ Siparişi Onayla</button>
    </form>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    // Miktar Güncelleme
    document.querySelectorAll(".quantity-input").forEach(input => {
        input.addEventListener("change", function () {
            const itemId = this.dataset.id;
            const quantity = this.value;

            fetch(`/orders/cart/update/${itemId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: new URLSearchParams({ quantity: quantity })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) alert("Geçersiz miktar!");
            });
        });
    });

    // Ürün Silme
    document.querySelectorAll(".remove-item-btn").forEach(button => {
        button.addEventListener("click", function () {
            const itemId = this.dataset.id;

            fetch(`/orders/cart/remove/${itemId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.removed) {
                    document.getElementById(`cart-item-${data.item_id}`).remove();
                    if (data.redirect) {
                        window.location.href = "{% url 'orders:ordercreate' %}";
                    }
                }
            });
        });
    });
});
</script>
{% endblock %}
