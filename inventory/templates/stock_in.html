{% extends "layout.html" %}
{% load crispy_forms_tags %}

{% block title %}Yeni Stok Girişi{% endblock %}

{% block body %}
    <h2 class="mb-4">Yeni Stok Girişi</h2>
    <form method="post">
        {% csrf_token %}
        {% crispy form %}
    </form>
    {% endblock body %}
    {% block extra_js %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const barcodeInput = document.getElementById('barcode');
            const refNoInput = document.getElementById('product_ref_no');
            const productNameInput = document.getElementById('product_name_tr');
            const stockQuantityInput = document.getElementById('product_stock_quantity');
            const quantityInput = document.getElementById('id_quantity');
            const barcodeFeedback = document.getElementById('barcode_feedback');
        
            function clearFields() {
                productNameInput.value = '';
                refNoInput.value = '';
                refNoInput.classList.remove('is-valid', 'is-invalid');
                stockQuantityInput.value = '';
                barcodeInput.value = '';
                barcodeInput.classList.remove('is-valid', 'is-invalid');
                barcodeFeedback.textContent = '';
                quantityInput.removeAttribute('max');
                quantityInput.placeholder = 'Giriş Adedi';
            }
            refNoInput.addEventListener('input', debounce(function () {
                const value = this.value.trim();
                if (value) {
                    fetchProduct(value, 'ref_no');
                } else {
                    clearFields(); // Ref No temizlenince diğer alanlar da temizlensin
                }
            }, 3000));
            function populateFields(data) {
                refNoInput.value = data.ref_no;
                barcodeInput.value = data.barcode;
                productNameInput.value = data.name_tr;
                stockQuantityInput.value = data.stock_quantity;
                barcodeInput.classList.add('is-valid');
                barcodeInput.classList.remove('is-invalid');
                refNoInput.classList.add('is-valid');
                refNoInput.classList.remove('is-invalid');
                barcodeFeedback.textContent = '';
                quantityInput.placeholder = 'Giriş Adedi';
            }
        
            function fetchProduct(query, type) {
                const url = type === 'barcode'
                    ? `{% url 'get_product_info_by_barcode_json' %}?barcode=${encodeURIComponent(query)}`
                    : `{% url 'get_product_info_by_refno_json' %}?ref_no=${encodeURIComponent(query)}`;
        
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        if (data.found) {
                            populateFields(data);
                        } else {
                            clearFields();
                            barcodeInput.classList.add('is-invalid');
                            barcodeFeedback.textContent = data.message || 'Ürün bulunamadı.';
                        }
                    })
                    .catch(() => {
                        clearFields();
                        barcodeInput.classList.add('is-invalid');
                        barcodeFeedback.textContent = 'Sunucu hatası oluştu.';
                    });
            }
        
            // Ref No girildiğinde
            refNoInput.addEventListener('input', debounce(function () {
                const value = this.value.trim();
                if (value) {
                    fetchProduct(value, 'ref_no');
                } else {
                    clearFields();  // Boşaldığında diğer alanları temizle
                }
            }, 3000));
        
            // Barkod girildiğinde
            barcodeInput.addEventListener('input', debounce(function () {
                const value = this.value.trim();
                if (value) {
                    fetchProduct(value, 'barcode');
                } else {
                    clearFields();
                }
            }, 5000));
        
            // Sayfa yüklendiğinde barkod varsa otomatik getir
            if (barcodeInput.value) {
                fetchProduct(barcodeInput.value.trim(), 'barcode');
            }
        
            function debounce(func, delay) {
                let timeout;
                return function (...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            }
        });
        </script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const startCameraBtn = document.getElementById('start-camera');
    const closeCameraBtn = document.getElementById('close-camera');
    const videoElem = document.getElementById('video');
    const cameraContainer = document.getElementById('camera-container');
    const barcodeInput = document.getElementById('barcode');

    let codeReader;
    let selectedDeviceId;

    startCameraBtn.addEventListener('click', async () => {
        cameraContainer.style.display = 'block';
        startCameraBtn.disabled = true;

        codeReader = new ZXing.BrowserMultiFormatReader();

        try {
            const videoInputDevices = await codeReader.listVideoInputDevices();
            if(videoInputDevices.length === 0){
                alert('Kamera bulunamadı!');
                return;
            }
            selectedDeviceId = videoInputDevices[0].deviceId;
            await codeReader.decodeFromVideoDevice(selectedDeviceId, videoElem, (result, err) => {
                if (result) {
                    barcodeInput.value = result.text;
                    // Okuma yapıldıktan sonra kamera durdurulur ve gizlenir
                    codeReader.reset();
                    cameraContainer.style.display = 'none';
                    startCameraBtn.disabled = false;
                }
                if (err && !(err instanceof ZXing.NotFoundException)) {
                    console.error(err);
                }
            });
        } catch (error) {
            alert('Kamera başlatılırken hata oluştu: ' + error);
            startCameraBtn.disabled = false;
            cameraContainer.style.display = 'none';
        }
    });

    closeCameraBtn.addEventListener('click', () => {
        if (codeReader) {
            codeReader.reset();
        }
        cameraContainer.style.display = 'none';
        startCameraBtn.disabled = false;
    });
});
</script>
        
    {% endblock %}
