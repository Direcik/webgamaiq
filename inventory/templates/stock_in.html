{% extends "layout.html" %}
{% load crispy_forms_tags %}

{% block title %}Yeni Stok GiriÅŸi{% endblock %}

{% block body %}
<h2 class="mb-4">Yeni Stok GiriÅŸi</h2>

<form method="post" novalidate>
    {% csrf_token %}
    {% crispy form %}
    
    <!-- Kamera aÃ§ma butonu formun iÃ§inde -->
    <button type="button" id="start-camera" class="btn btn-outline-primary mt-3 w-100" title="Kamera ile Tara">
        ðŸ“· KamerayÄ± AÃ§
    </button>
</form>

<!-- Fullscreen kamera container -->
<div id="camera-container" style="
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100vw; height: 100vh;
    background-color: black;
    z-index: 1050;
    overflow: hidden;
">
    <div id="reader" style="
        width: 100%;
        height: 100%;
        object-fit: cover;
    "></div>

    <button id="close-camera" type="button" style="
        position: fixed;
        top: 15px;
        right: 15px;
        background: rgba(255,0,0,0.85);
        border: none;
        color: white;
        font-size: 1.5rem;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        cursor: pointer;
        z-index: 1100;
    " title="KamerayÄ± Kapat">âœ•</button>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const barcodeInput = document.getElementById('barcode');
    const refNoInput = document.getElementById('product_ref_no');
    const productNameInput = document.getElementById('product_name_tr');
    const stockQuantityInput = document.getElementById('product_stock_quantity');
    const quantityInput = document.getElementById('id_quantity');
    const barcodeFeedback = document.getElementById('barcode_feedback');

    function clearFields() {
        productNameInput.value = '';
        refNoInput.value = '';
        refNoInput.classList.remove('is-valid', 'is-invalid');
        stockQuantityInput.value = '';
        barcodeInput.value = '';
        barcodeInput.classList.remove('is-valid', 'is-invalid');
        barcodeFeedback.textContent = '';
        quantityInput.removeAttribute('max');
        quantityInput.placeholder = 'GiriÅŸ Adedi';
    }

    function debounce(func, delay) {
        let timeout;
        return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    function populateFields(data) {
        refNoInput.value = data.ref_no;
        barcodeInput.value = data.barcode;
        productNameInput.value = data.name_tr;
        stockQuantityInput.value = data.stock_quantity;
        barcodeInput.classList.add('is-valid');
        barcodeInput.classList.remove('is-invalid');
        refNoInput.classList.add('is-valid');
        refNoInput.classList.remove('is-invalid');
        barcodeFeedback.textContent = '';
        quantityInput.placeholder = 'GiriÅŸ Adedi';
    }

    function fetchProduct(query, type) {
        const url = type === 'barcode'
            ? `{% url 'get_product_info_by_barcode_json' %}?barcode=${encodeURIComponent(query)}`
            : `{% url 'get_product_info_by_refno_json' %}?ref_no=${encodeURIComponent(query)}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.found) {
                    populateFields(data);
                } else {
                    clearFields();
                    barcodeInput.classList.add('is-invalid');
                    barcodeFeedback.textContent = data.message || 'ÃœrÃ¼n bulunamadÄ±.';
                }
            })
            .catch(() => {
                clearFields();
                barcodeInput.classList.add('is-invalid');
                barcodeFeedback.textContent = 'Sunucu hatasÄ± oluÅŸtu.';
            });
    }

    refNoInput.addEventListener('input', debounce(function () {
        const value = this.value.trim();
        if (value) {
            fetchProduct(value, 'ref_no');
        } else {
            clearFields();
        }
    }, 3000));

    barcodeInput.addEventListener('input', debounce(function () {
        const value = this.value.trim();
        if (value) {
            fetchProduct(value, 'barcode');
        } else {
            clearFields();
        }
    }, 5000));

    if (barcodeInput.value) {
        fetchProduct(barcodeInput.value.trim(), 'barcode');
    }

    // Kamera aÃ§ma & kapama iÅŸlemleri
    const startCameraBtn = document.getElementById('start-camera');
    const cameraContainer = document.getElementById('camera-container');
    const closeCameraBtn = document.getElementById('close-camera');
    const readerDivId = 'reader';

    let html5QrCode = null;

    startCameraBtn.addEventListener('click', function () {
        cameraContainer.style.display = 'block';

        if (!html5QrCode) {
            html5QrCode = new Html5Qrcode(readerDivId);
        }

        Html5Qrcode.getCameras().then(cameras => {
            if (cameras && cameras.length) {
                const backCamera = cameras.find(cam => cam.label.toLowerCase().includes('back'));
                const cameraId = backCamera ? backCamera.id : cameras[0].id;

                html5QrCode.start(
                    cameraId,
                    {
                        fps: 10,
                        qrbox: false, // fullscreen tarama (Ã§erÃ§evesiz)
                        formatsToSupport: [Html5QrcodeSupportedFormats.EAN_13, Html5QrcodeSupportedFormats.CODE_128, Html5QrcodeSupportedFormats.QR_CODE]
                    },
                    (decodedText, decodedResult) => {
                        barcodeInput.value = decodedText;
                        barcodeInput.classList.remove('is-invalid');
                        barcodeInput.classList.add('is-valid');
                        barcodeFeedback.textContent = '';

                        fetchProduct(decodedText, 'barcode');

                        html5QrCode.stop().then(() => {
                            cameraContainer.style.display = 'none';
                        }).catch(err => {
                            console.error('Kamera durdurma hatasÄ±:', err);
                        });
                    },
                    (errorMessage) => {
                        // Ä°stersen buraya hata mesajlarÄ± ekleyebilirsin, ama genelde boÅŸ bÄ±rakÄ±lÄ±r
                    }
                ).catch(err => {
                    alert("Kamera baÅŸlatÄ±lamadÄ±: " + err);
                });
            } else {
                alert('Cihazda kamera bulunamadÄ±.');
            }
        }).catch(err => {
            alert("Kamera bilgisi alÄ±namadÄ±: " + err);
        });
    });

    closeCameraBtn.addEventListener('click', function () {
        if (html5QrCode) {
            html5QrCode.stop().then(() => {
                cameraContainer.style.display = 'none';
            }).catch(err => {
                console.error('Kamera kapatma hatasÄ±:', err);
            });
        } else {
            cameraContainer.style.display = 'none';
        }
    });
});
</script>
{% endblock %}
