{% extends "layout.html" %}
{% load crispy_forms_tags %}

{% block title %}Yeni Stok Girişi{% endblock %}

{% block body %}
    <h2 class="mb-4">Yeni Stok Girişi</h2>
    <form method="post" novalidate>
        {% csrf_token %}
        {% crispy form %}
        <div id="camera-container" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:black; z-index:10000;">
            <div id="reader" style="width:100%; height:100%;"></div>
            <button id="close-camera" type="button" 
                    style="position:absolute; top:10px; right:10px; z-index:10001; background:rgba(255,0,0,0.8); border:none; color:white; font-size:24px; border-radius:50%; width:40px; height:40px; cursor:pointer;"
                    title="Kamerayı Kapat">×</button>
          </div>
    </form>

{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const barcodeInput = document.getElementById('barcode');
    const refNoInput = document.getElementById('product_ref_no');
    const productNameInput = document.getElementById('product_name_tr');
    const stockQuantityInput = document.getElementById('product_stock_quantity');
    const quantityInput = document.getElementById('id_quantity');
    const barcodeFeedback = document.getElementById('barcode_feedback');

    // Mevcut debounce, fetchProduct vs. kodun aynen burada olacak
    function clearFields() {
        productNameInput.value = '';
        refNoInput.value = '';
        refNoInput.classList.remove('is-valid', 'is-invalid');
        stockQuantityInput.value = '';
        barcodeInput.value = '';
        barcodeInput.classList.remove('is-valid', 'is-invalid');
        barcodeFeedback.textContent = '';
        quantityInput.removeAttribute('max');
        quantityInput.placeholder = 'Giriş Adedi';
    }

    function debounce(func, delay) {
        let timeout;
        return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    function populateFields(data) {
        refNoInput.value = data.ref_no;
        barcodeInput.value = data.barcode;
        productNameInput.value = data.name_tr;
        stockQuantityInput.value = data.stock_quantity;
        barcodeInput.classList.add('is-valid');
        barcodeInput.classList.remove('is-invalid');
        refNoInput.classList.add('is-valid');
        refNoInput.classList.remove('is-invalid');
        barcodeFeedback.textContent = '';
        quantityInput.placeholder = 'Giriş Adedi';
    }

    function fetchProduct(query, type) {
        const url = type === 'barcode'
            ? `{% url 'get_product_info_by_barcode_json' %}?barcode=${encodeURIComponent(query)}`
            : `{% url 'get_product_info_by_refno_json' %}?ref_no=${encodeURIComponent(query)}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.found) {
                    populateFields(data);
                } else {
                    clearFields();
                    barcodeInput.classList.add('is-invalid');
                    barcodeFeedback.textContent = data.message || 'Ürün bulunamadı.';
                }
            })
            .catch(() => {
                clearFields();
                barcodeInput.classList.add('is-invalid');
                barcodeFeedback.textContent = 'Sunucu hatası oluştu.';
            });
    }

    refNoInput.addEventListener('input', debounce(function () {
        const value = this.value.trim();
        if (value) {
            fetchProduct(value, 'ref_no');
        } else {
            clearFields();
        }
    }, 3000));

    barcodeInput.addEventListener('input', debounce(function () {
        const value = this.value.trim();
        if (value) {
            fetchProduct(value, 'barcode');
        } else {
            clearFields();
        }
    }, 5000));

    if (barcodeInput.value) {
        fetchProduct(barcodeInput.value.trim(), 'barcode');
    }

    // --- html5-qrcode ile kamera ve barkod tarama kodu ---

    const startCameraBtn = document.getElementById('start-camera');
    const cameraContainer = document.getElementById('camera-container');
    const closeCameraBtn = document.getElementById('close-camera');
    let html5QrCode = null;
    
    function openFullscreen(elem) {
      if (elem.requestFullscreen) {
        elem.requestFullscreen();
      } else if (elem.webkitRequestFullscreen) { /* Safari */
        elem.webkitRequestFullscreen();
      } else if (elem.msRequestFullscreen) { /* IE11 */
        elem.msRequestFullscreen();
      }
    }
    
    function closeFullscreen() {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.webkitExitFullscreen) { /* Safari */
        document.webkitExitFullscreen();
      } else if (document.msExitFullscreen) { /* IE11 */
        document.msExitFullscreen();
      }
    }
    
    startCameraBtn.addEventListener('click', () => {
      cameraContainer.style.display = 'block';
    
      openFullscreen(cameraContainer);  // Tam ekran yap
    
      if (!html5QrCode) {
        html5QrCode = new Html5Qrcode("reader");
      }
    
      Html5Qrcode.getCameras().then(cameras => {
        if (cameras && cameras.length) {
          const backCamera = cameras.find(cam => cam.label.toLowerCase().includes('back'));
          const cameraId = backCamera ? backCamera.id : cameras[0].id;
    
          html5QrCode.start(
            cameraId,
            {
              fps: 10,
              qrbox: false,
              formatsToSupport: [Html5QrcodeSupportedFormats.EAN_13]
            },
            (decodedText) => {
              // Barkod okundu
              console.log("Decoded:", decodedText);
              // ... input'a yaz, formu güncelle, vs.
              
              html5QrCode.stop().then(() => {
                closeFullscreen();
                cameraContainer.style.display = 'none';
              });
            },
            (errorMessage) => {
              // Hata mesajları (genelde boş bırakılır)
            }
          ).catch(err => {
            alert("Kamera başlatılamadı: " + err);
          });
    
        } else {
          alert('Cihazda kamera bulunamadı.');
        }
      }).catch(err => {
        alert("Kamera bilgisi alınamadı: " + err);
      });
    });
    
    closeCameraBtn.addEventListener('click', () => {
      if (html5QrCode) {
        html5QrCode.stop().then(() => {
          closeFullscreen();
          cameraContainer.style.display = 'none';
        });
      } else {
        closeFullscreen();
        cameraContainer.style.display = 'none';
      }
    });
</script>


{% endblock %}
